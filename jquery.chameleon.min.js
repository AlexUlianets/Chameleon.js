"use strict";!function(a,b,c){var d={color:{black:"#000000",white:"#ffffff",adapt_limit:200,alpha:200,distinction:120,readable_lum_diff:5},limits:{color_alpha:{min:0,max:255},color_distinction:{min:50,max:765},color_adapt_limit:{min:0,max:1e3}},canvas:{add_w:10,add_h:10},actions:{},sel:{chmln:".chmln",chmln_canvas:".chmln__canvas",chmln_img:".chmln__img",chmln_colors:".chmln__colors",chmln_async_colorize:".chmln_async_colorize",chmln_colorize_done:".chmln_colorize_done"},$:{},tpl:{}},f={debug:!1},g=function(a){return a.slice(1)},h=function(a){return void 0===a},i=function(a){f.debug=!!a&&!!a.debug},j=function(a,b){if(f.debug){b=b||"log";var c={error:function(a){console.error("Chameleon.js:",a)},warn:function(a){console.warn("Chameleon.js:",a)},log:function(a){console.log("Chameleon.js:",a)}};h(a)?c.error("Msg given to logger is undefined!"):c.hasOwnProperty(b)?c[b](a):c.error(["Unknown logAction type!",b])}},k=function(a,b,c){if(a&&a.length)return h(b)||(a.hasClass(g(d.sel.chmln_async_colorize))?a.attr("data-stopColorize",b):j("Cant stop colorize in not async_colorize mode!","warn")),c&&a.removeAttr("data-stopColorize"),a.attr("data-stopColorize");j("getStopColorize $elem not given or all $elems are already colorized!","warn")},l=function(b){b=b||{};var c=b.settings_type||"colorizeContent",e={colorizeContent:{settings_type:"colorizeContent",dummy_back:"aaaaaa",dummy_front:"555555",color_alpha:d.color.alpha,color_distinction:d.color.distinction,color_adapt_limit:d.color.adapt_limit,debug:!1,async_colorize:!0,apply_colors:!0,adapt_colors:!0,all_colors:!1,insert_colors:!1,data_colors:!1,rules:{},afterColorized:function(){},beforeAsyncColorized:function(){},afterAsyncColorized:function(){}},getImageColors:{settings_type:"getImageColors",sort_colors:"primary",color_alpha:d.color.alpha,color_distinction:d.color.distinction,debug:!1,onGetColorsSuccess:function(a,b,c){j(["getImageColors - onGetColorsSuccess is not given!",a,b,c],"warn")},onGetColorsError:function(a,b,c){j(["getImageColors - error on img load!",a,b,c],"error")}}};return e[c]?a.extend(e[c],b.settings_values||{}):(j('getDefaultSettings - Unknown settings type given "'+c+'"!',"warn"),{})},m=function(b,c){return a.extend(b||{},c||{})},n=function(b){if("object"==typeof b){i(b);var c=a.extend({},b),e={settings_type:["colorizeContent","getImageColors"],sort_colors:["primary","hue"]},f=[{type:"number",msg:function(a){return"Should be a number. Min: "+d.limits[a].min+", max: "+d.limits[a].max+"."},items:["color_alpha","color_distinction","color_adapt_limit"]},{type:"string",msg:function(){return"Should be a string."},items:["settings_type","sort_colors"]},{type:"hex",msg:function(){return"Should be a hex color: #xxx or #xxxxxx."},items:["dummy_back","dummy_front","hex","color"]},{type:"boolean",msg:function(){return"Should be a boolean value: true or false."},items:["debug","async_colorize","apply_colors","adapt_colors","all_colors","insert_colors","data_colors"]},{type:"object",msg:function(){return"Should be an object."},items:["$img","rules","settings_values"]},{type:"function",msg:function(){return"Should be a function."},items:["afterColorized","beforeAsyncColorized","afterAsyncColorized","onGetColorsSuccess","onGetColorsFail"]}],g=function(a,b,c){var d=a;return"function"!=typeof c||b||(d=c(a)),{is_valid:b,fixed_val:d}},h={numberValidation:function(a,b){a=parseFloat(a);var c=!0;return d.limits.hasOwnProperty(b)?c=!isNaN(a)&&d.limits[b].min<=a&&a<=d.limits[b].max:j('validateSettings/checkNumberValue - limits for number setting "'+b+'" are missing!',"warn"),g(a,c,function(a){return a=isNaN(a)?d.limits[b].min:Math.min(Math.max(a,d.limits[b].min),d.limits[b].max)})},stringValidation:function(a){return g(a,"string"==typeof a,function(a){return String(a)})},hexValidation:function(a){return g(a,/^#[0-9a-f]{6}$/i.test(r(a).toLowerCase()),function(a){return s(a)})},booleanValidation:function(a){return g(a,"boolean"==typeof a,function(a){return!!a})},objectValidation:function(a){return g(a,"object"==typeof a,function(a){return{}})},functionValidation:function(a){return g(a,"function"==typeof a,function(a){return function(){}})}},k=function(a){var b=[];for(var d in a)a.hasOwnProperty(d)&&b.push(l(a[d],d));return b},l=function(b,c){var d=!1,g="";if(a.each(f,function(a,b){if(-1!==b.items.indexOf(c))return d=b.type,g=b.msg(c),!1}),d){var i=h[d+"Validation"](b,c);return e.hasOwnProperty(c)&&-1===e[c].indexOf(b)&&(i.fixed_val=e[c][0],i.is_valid=!1,g='Not allowed value for "'+c+'". You can use only: ['+e[c].join(", ")+"]."),{prop:c,val:b,fixed_val:i.fixed_val,valid:i.is_valid,msg:g}}return j('validateSettings - Unknown val_type "'+c+'".',"warn"),{prop:c,val:b,fixed_val:b,valid:!1,msg:'Unknown value type "'+c+'".'}},m=function(a){return!a.valid},n=k(b).filter(m);return a.each(n,function(a,b){c[b.prop]=b.fixed_val}),{invalid:n,fixed_settings:c}}return{invalid:[],fixed_settings:b}},o=function(a,b){for(var c in b)b.hasOwnProperty(c)&&a.attr(c,b[c]);return a},p=function(a){var b=[],c=[];for(var d in a)a.hasOwnProperty(d)&&b.push([d,a[d]]);b.sort(function(a,b){return b[1]-a[1]});for(var e=0;e<b.length;e+=1)c[b[e][0]]=b[e][1];return c},q=function(a,b){b=b||2;for(var c=Number(a).toString(16);c.length<b;)c="0"+c;return c},r=function(a){return a?"#"+String(a).replace(/#/g,""):""},s=function(a){return a?(a=String(a).replace(/[^0-9a-f]/gi,"").toLowerCase(),a.length<6&&(a=a.length>=3?a[0]+a[0]+a[1]+a[1]+a[2]+a[2]:d.color.black),a.length>6&&(a=a.slice(0,6)),a):""},t=function(a){a=s(a);var b=0,c=2,d=4,f=360,g=parseInt(a.substr(b,2),16),h=parseInt(a.substr(c,2),16),i=parseInt(a.substr(d,2),16),j=Math.max(g,h,i),k=Math.min(g,h,i),l=j,m=j-k,n=0,o=0;return l>0&&(o=m/l)>0&&(g===j?(n=b*f+f*((h-k-(i-k))/m))<0&&(n+=6*f):h===j?n=c*f+f*((i-k-(g-k))/m):i===j&&(n=d*f+f*((g-k-(h-k))/m))),{hex:a,r:g,g:h,b:i,chroma:m,hue:n,sat:o,val:l}},u=function(a){var b="";if(Array.isArray(a))for(var c=0;c<3;c+=1)b+=q(a[c]);else"object"==typeof a&&(b+=q(a.r)+q(a.g)+q(a.b));return s(b)},v=function(a,b){var c=function(a){var e=255,f=2.2;return.2126*Math.pow(a.r/e,f)+.7152*Math.pow(a.g/e,f)+.0722*Math.pow(a.b/e,f)},d=c(a),e=c(b),f=.05;return d>e?(d+f)/(e+f):(e+f)/(d+f)},w=function(a,b){a=s(a),b=b||0;for(var d,c="#",e=0;e<3;e+=1)d=parseInt(a.substr(2*e,2),16),d=Math.round(Math.min(Math.max(0,d+d*b),255)).toString(16),c+=("00"+d).substr(d.length);return c},x=function(a,b,c,e,f){for(var g="",h=.05,i=1;v(a,b)<d.color.readable_lum_diff&&(g=w(c,e*h*i),i+=1,b=t(g),!(i>f)););return i>f?e>0?d.color.white:d.color.black:g},y=function(a){return v(t(a),t(d.color.black))>=d.color.readable_lum_diff?d.color.black:d.color.white},z=function(a,b,c){var e=t(a),f=t(c),g="",h=1;return v(e,f)>=d.color.readable_lum_diff?g=r(c):(v(e,t(d.color.black))>=d.color.readable_lum_diff&&(h=-1),g=x(e,f,c,h,b)),g},A=function(b){if(b){var c=r(s(b.color||"")),d=r(s(b.source_color||"")),e=a('<div class="chmln__colors-elem-wrapper">'),f=a('<span class="chmln__colors-elem">'),g=a('<span class="chmln__colors-elem _source">'),h=a('<span class="chmln__colors-arrow">'),i=d&&d!==c,j=function(a,b,c){a.css({"background-color":b,color:y(b)}).html(c)};return j(f,c,c),i&&(j(g,d,d),j(h,d,"&#8594"),f.addClass("_adapted"),g.append(h),e.append(g)),e.append(f),e}},B=function(b,c,e){var f=b||[],h=[];if(f.length){var i=[],j=c[0]||s(e.dummy_back),k=1,l=f.find(d.sel.chmln+k);for(h.push(r(j));l.length>0;)i.push(l),k+=1,l=f.find(d.sel.chmln+k);for(;c.length<k;)c.push(s(e.dummy_front));if(e.adapt_colors){var m=c.slice(1,k).map(z.bind(this,j,e.color_adapt_limit));h=h.concat(m)}else for(var n=1;n<k;n+=1)h.push(r(c[n]));if(e.apply_colors){f.css("background-color",r(j));for(var p=0;p<i.length;p+=1){i[p].css("color",h[p+1]);for(var q=0;q<i[p].length;q+=1){var t=i[p][q].nodeName.toLowerCase();if(e.rules.hasOwnProperty(t))for(var u=e.rules[t].split(","),v=u.length,w=0;w<v;w+=1)i[p][q].style[u[w].replace(/\s/g,"")]=h[p+1]}}}if(e.insert_colors){var x=f.find(d.sel.chmln_colors);x.length?x.html(""):(x=a('<div class="'+g(d.sel.chmln_colors)+'">'),f.append(x)),a.each(c,function(a,b){0===a?x.append(A({color:j})):h[a]?x.append(A({color:h[a],source_color:b})):e.all_colors&&x.append(A({color:b}))})}if(e.all_colors){var y=c.slice(h.length).map(r);h=h.concat(y)}e.data_colors&&o(f,{"data-colors":h}),f.addClass(g(d.sel.chmln_colorize_done))}return h},C=function(b){if(b){b.type=b.type||"primary";var c={primary:function(a){return a},hue:function(b){return b.map(function(b){return a.fn.chameleon("colorObjectFromHex",{hex:b})}).sort(function(a,b){return a.hue-b.hue}).map(function(a){return r(a.hex)})}};if(c.hasOwnProperty(b.type)&&b.colors&&b.colors.length)return c[b.type](b.colors);j('sortImageColors - Unknown sort type "'+b.type+'".',"warn")}return[]},D=function(b,c,e,f,h){var i=a("<img>");i.on({load:function(c){var h=c.target,i=h.width+d.canvas.add_w,j=h.height+d.canvas.add_h,k=b.find(d.sel.chmln_canvas),l=o(a("<canvas>"),{class:g(d.sel.chmln_canvas),style:"display: none;",width:i,height:j});k.remove(),b.append(l);var m=l[0].getContext("2d"),n=[];m.clearRect(0,0,i,j),m.drawImage(h,0,0);for(var q=m.getImageData(0,0,i,j).data,r="",s=0;s<q.length;s+=4)q[s+3]>=e.color_alpha&&(r=q[s]+","+q[s+1]+","+q[s+2]+","+q[s+3],n[r]?n[r]+=1:n[r]=1);var t=p(n),v=[];n=[];for(var w in t)if(t.hasOwnProperty(w)){for(var x=w.split(","),y=!0,z=0;z<v.length;z+=1){for(var A=0,B=v[z].split(","),D=0;D<3;D+=1)A+=Math.abs(x[D]-B[D]);if(A<=e.color_distinction){y=!1;break}}y&&(v.push(w),n.push(u(x)))}e.sort_colors&&(n=C({type:e.sort_colors,colors:n})),f(n,b,e)},error:function(){h(c,b,e)}}),i.attr("src",c)},E={colorizeContent:function(b,c){var e=m(l(),c),f=function(){var b=a(this),c=m(e,{$img:b.find(d.sel.chmln_img).first()});c.$img.length?D(b,c.$img[0].src,e,function(a,b,d){var e=B(b,a,d);d.async_colorize||"function"!=typeof c.afterColorized||c.afterColorized(e)},function(a,b,d){d.async_colorize||"function"!=typeof c.afterColorized||c.afterColorized([]),j('Failed to load image with url "'+a+'".',"error")}):j("Image not found. Each individual material must contain at least one image.","error")};if(b.length||j("Nothing found, probably, bad selector.","error"),b.removeClass(g(d.sel.chmln_colorize_done)).toggleClass(g(d.sel.chmln_async_colorize),!!e.async_colorize),e.async_colorize){var i=function(){var c=!1;return b.length&&(c=b.splice(0,1)[0]),a(c)},n=function(a){a&&a.length&&(h(k(a))?(f.call(a),a=i(),a.length?setTimeout(n.bind(null,a),0):"function"==typeof e.afterAsyncColorized&&e.afterAsyncColorized()):k(a,"",!0))};"function"==typeof e.beforeAsyncColorized&&e.beforeAsyncColorized(),n(i())}else b.each(f)},getImageColors:function(b,c){var d=function(){var b=a(this),d=m(l({settings_type:"getImageColors",settings_values:{$img:b}}),c);"img"===b[0].nodeName.toLowerCase()?D(b.parent(),b.attr("src"),d,d.onGetColorsSuccess,d.onGetColorsError):j('Given element is not "img"!',"error")};b.each(d)},stopColorize:function(a){var b=a.filter(":not("+d.sel.chmln_colorize_done+")");b.length&&k(b,1)},get_s:{result:function(){return d}},getDefaultSettings:{result:function(a){return l(a)}},getColorElem:{result:function(a){return A(a)}},colorObjectFromHex:{result:function(a){return t(a.hex)}},sortColors:{result:function(a){return C(a)}}};a.fn.chameleon=function(b,c){var d=a(this),e="string"==typeof b,f=n(e?c:b);if(c=f.fixed_settings,f.invalid.length&&j(["Bad settings are fixed!",f.invalid],"warn"),e)if(E.hasOwnProperty(b)){if(E[b].result&&"function"==typeof E[b].result)return E[b].result(c);E[b](d,c)}else j(["Unknown action!",b],"error");else E.colorizeContent(d,c);return this}}(jQuery,window);